[
  {
    "Id": "1229378",
    "ThreadId": "540910",
    "Html": "My program records screen &amp; mic &amp; speaker in webm. <br />\n<ol>\n<li>How i can add audio samples recorded by NAudio to Video?</li>\n<li>\nWhat I need to have synchronzed video &amp; audio ( i screenshot 3 times/sec &amp; add it to video )?<br />\n</li>\n</ol>\nHere are my functions.. <br />\n<br />\n C++ part : <br />\n<blockquote>\nchar* ByteArray_to_charptr(array&lt;System::Byte&gt;^ byteArray)<br />\n{<br />\n   pin_ptr&lt;System::Byte&gt; p = &amp;byteArray[0];<br />\n   unsigned char* pby = p;<br />\n   char* pch = reinterpret_cast&lt;char*&gt;(pby);<br />\nreturn pch;<br />\n   // use it...<br />\n}<br />\n<br />\nvoid VideoEncoder::AddAudioSampleBuffer(array&lt;System::Byte&gt;^ byteArray,int^ buffersize)<br />\n{<br />\nchar * buffer=ByteArray_to_charptr(byteArray);<br />\n<br />\nif (buffer &amp;&amp; (int)buffersize &gt; 0)<br />\n{<br />\n<pre><code>AddAudioSample(pFormatContext,pVideoStream,buffer,(int)buffersize);</code></pre>\n\n}<br />\n}<br />\n<br />\nbool VideoEncoder::AddAudioSample(AVFormatContext *pFormatContext, AVStream *pStream, <br />\n<pre><code>                                   const char* soundBuffer, int soundBufferSize)</code></pre>\n\n{<br />\nAVCodecContext *pCodecCxt;  <br />\n bool res = true;<br />\n<br />\n pCodecCxt       = pStream-&gt;codec;<br />\n  memcpy(audioBuffer + nAudioBufferSizeCurrent, soundBuffer, soundBufferSize);<br />\n  nAudioBufferSizeCurrent += soundBufferSize;<br />\n<br />\n  BYTE * pSoundBuffer = (BYTE *)audioBuffer;<br />\n int nCurrentSize    = nAudioBufferSizeCurrent;<br />\n<br />\n// Size of packet on bytes.<br />\n// FORMAT s16<br />\n DWORD packSizeInSize = 2 * audioInputSampleSize;<br />\n<br />\n while(nCurrentSize &gt;= packSizeInSize)<br />\n {<br />\n   AVPacket pkt;<br />\n  av_init_packet(&amp;pkt);<br />\n<br />\n  pkt.size = avcodec_encode_audio(pCodecCxt, pAudioEncodeBuffer, <br />\n<pre><code> nSizeAudioEncodeBuffer, (const short *)pSoundBuffer);\n</code></pre>\n\nif (pCodecCxt-&gt;coded_frame &amp;&amp; pCodecCxt-&gt;coded_frame-&gt;pts != AV_NOPTS_VALUE)<br />\n   {<br />\n<pre><code> pkt.pts = av_rescale_q(pCodecCxt-&gt;coded_frame-&gt;pts, pCodecCxt-&gt;time_base, &gt;pStream-&gt;time_base);</code></pre>\n\n}<br />\n<br />\n   pkt.flags |= AV_PKT_FLAG_KEY;<br />\n   pkt.stream_index = pStream-&gt;index;<br />\n   pkt.data = pAudioEncodeBuffer;<br />\n<br />\n   // Write the compressed frame in the media file.<br />\n   if (av_interleaved_write_frame(pFormatContext, &amp;pkt) != 0) <br />\n   {<br />\n<pre><code> res = false;\n break;</code></pre>\n\n}<br />\n<br />\n   nCurrentSize -= packSizeInSize;<br />\n   pSoundBuffer += packSizeInSize;    <br />\n }<br />\n<br />\n // save excess<br />\n memcpy(audioBuffer, audioBuffer + nAudioBufferSizeCurrent - nCurrentSize, nCurrentSize);<br />\n nAudioBufferSizeCurrent = nCurrentSize; <br />\n<br />\n return res;<br />\n}<br />\n</blockquote>\n&amp; C# part<br />\n<blockquote>\nprivate static void wmic_DataAvailable(object sender, NAudio.Wave.WaveInEventArgs e)<br />\n<pre><code>   {\n       if (e.BytesRecorded &gt; 0)\n           vencoder.AddAudioSampleBuffer(e.Buffer, e.BytesRecorded);\n   }\n</code></pre>\n\n</blockquote>\nThis adds audio to video but I hear no audio or sometimes video also doesn't play at all.<br />\n",
    "PostedDate": "2014-04-02T03:04:41.99-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]