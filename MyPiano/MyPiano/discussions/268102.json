[
  {
    "Id": "654071",
    "ThreadId": "268102",
    "Html": "<p>Hi all,</p>\n<p>i'm using naudio 1.4 in network audio chat scenario, after success working one to one communication, i'm trying to support multi client chat. I'm using WaveMixerStream32 to mix raw data coming from differents client. The waveformat of coming audio (for every  clients) is 16 bit PCM 16Khz 1 channel.</p>\n<p>Follow used code to configure WaveMixerStream32:</p>\n<div style=\"color: black; background-color: white;\">\n<pre><span style=\"color: blue;\">this</span>.mixer = WaveMixerStream32();<br /><span style=\"color: blue;\">var</span> wavePlayer = <span style=\"color: blue;\">new</span> WaveOut();<br />wavePlayer.DesiredLatency = this.DesiredLatencyMs; //Value used for test is 100ms<br />wavePlayer.Init(mixer);<br /></pre>\n</div>\n<p>Mixer WaveFormat after this code&nbsp;is IeeeFloat, 16000 sample rate, 2 channels, 32 bitsPerSample.<br /> When&nbsp;raw data coming I check if samples come from a new channel, if yes I add to mixer a new input stream as follow:</p>\n<pre><div style=\"color: black; background-color: white;\"><pre><span style=\"color: blue;\">public</span> <span style=\"color: blue;\">void</span> PlaySamples(<span style=\"color: blue;\">int</span> clientid, <span style=\"color: blue;\">byte</span>[] samples)<br />{<br />  <span style=\"color: blue;\">if</span> (!<span style=\"color: blue;\">this</span>.ClientIsInitialized(clientid))<br />  {<br />     <span style=\"color: blue;\">var</span> waveProvider = <span style=\"color: blue;\">new</span> BufferedWaveProvider(<span style=\"color: blue;\">this</span>.format);<br />     waveProvider.MaxQueuedBuffers = <span style=\"color: blue;\">this</span>.numberOfBuffers;<br />     waveProvider.DiscardOnBufferOverflow = <span style=\"color: blue;\">false</span>;<br />     <span style=\"color: blue;\">var</span> stream = <span style=\"color: blue;\">new</span> WaveProviderToWaveStream(waveProvider); <span style=\"color: green;\">//code of WaveProviderToWaveStream is omitted because out of scope</span><br />     <span style=\"color: blue;\">this</span>.mixer.AddInputStream(<span style=\"color: blue;\">new</span> WaveChannel32(stream));<br />     <span style=\"color: blue;\">this</span>.AddClient(clientid, waveProvider);<br />   }<br />   <span style=\"color: blue;\">this</span>.GetClient(clientid).AddSamples(samples, 0, samples.Length);<br />}</pre>\n</div>\n<br /></pre>\n<p>If I connect only one client and after first&nbsp;PlaySamples call&nbsp;(first sample is 3200 bytes long), mixer call Read method passing as parameter buffer 17640 bytes long. WaveChannel32 throw System.ArgumentException after Read, with follow message and StackTrace:<br /> Message: \"The byte buffer to bound must be 4 bytes aligned\"</p>\n<p>StackTrace:<br /> at NAudio.Wave.WaveBuffer.BindTo(Byte[] bufferToBoundTo)&nbsp;&nbsp; <br /> at NAudio.Wave.WaveBuffer..ctor(Byte[] bufferToBoundTo)&nbsp;&nbsp; <br /> at NAudio.Wave.SampleProviders.Mono16SampleProvider.LoadNextChunk(IWaveProvider source, Int32 samplePairsRequired)&nbsp;&nbsp; <br /> at NAudio.Wave.WaveChannel32.Read(Byte[] destBuffer, Int32 offset, Int32 numBytes)&nbsp;&nbsp; <br /> at NAudio.Wave.WaveMixerStream32.Read(Byte[] buffer, Int32 offset, Int32 count)</p>\n<p>If I use one to one configuration&nbsp;and&nbsp;init wavePlayer directly with WaveChannel32 excluding WaveMixerStream32 ,all work fine and no exception was threw.</p>\n<p>I'm thinking problem is due to latency (100ms) set to configure wave player that trigger read buffer size request to mixer, but I don't know how choose latency size (or adjust user specified latency)&nbsp;in order to&nbsp;avoid error.</p>\n<p>In last trunk code of naudio, BindTo method comment raise of exception adding comment: \"WaveBuffer assumes the caller knows what they are doing. We will let this pass\"; I'm sure, I don't know what I'm doing :P</p>\n<p>Thanks for your support<br /> Regards,<br /> Gianluca</p>",
    "PostedDate": "2011-08-07T08:13:04.933-07:00",
    "UserRole": null,
    "MarkedAsAnswerDate": null
  }
]